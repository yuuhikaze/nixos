global
  log /dev/log local0
  log /dev/log local1 notice
  chroot /var/lib/haproxy
  stats socket /run/haproxy/admin.sock mode 660 level admin
  stats timeout 30s
  user haproxy
  group haproxy
  daemon

  # Default SSL material locations
  ca-base /etc/ssl/certs
  crt-base /etc/ssl/private

  # Performance tuning
  maxconn 4096
  tune.ssl.default-dh-param 2048

defaults
  log     global
  mode    tcp
  option  tcplog
  option  dontlognull
  timeout connect 5s
  timeout client  30s
  timeout server  30s

# ============================================
# Frontend: SSL/TLS Router on port 443
# ============================================
frontend ssl_router
  bind *:443
  mode tcp

  # Wait for TLS ClientHello to inspect SNI
  tcp-request inspect-delay 5s
  tcp-request content accept if { req_ssl_hello_type 1 }

  # Route based on SNI (Server Name Indication)
  # Minecraft server
  use_backend minecraft if { req_ssl_sni -i mc.yuuhikaze.com }

  # Kubernetes cluster (all other *.yuuhikaze.com domains)
  default_backend kubernetes

# ============================================
# Backend: Minecraft Server (SSL Passthrough)
# ============================================
backend minecraft
  mode tcp
  option tcp-check

  # Minecraft runs locally on the NixOS host
  server minecraft 127.0.0.1:25565 check

# ============================================
# Backend: Kubernetes Cluster (SSL Passthrough)
# ============================================
backend kubernetes
  mode tcp
  balance roundrobin
  option tcp-check

  # Health check (TCP connection to k8s ingress)
  tcp-check connect

  # Kubernetes nodes (Contour ingress will terminate TLS)
  # Update these IPs with your actual Talos node addresses
  server k8s-192.168.100.50 192.168.100.50:443 check
  # server k8s-192.168.100.51 192.168.100.51:443 check
  # server k8s-192.168.100.52 192.168.100.52:443 check

# ============================================
# Stats Page (Optional - for monitoring)
# ============================================
listen stats
  bind *:8404
  mode http
  stats enable
  stats uri /stats
  stats refresh 10s
  stats admin if TRUE
